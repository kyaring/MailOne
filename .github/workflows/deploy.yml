name: Deploy MailOne [Cloudflare Worker + D1]

on:
  push:
    branches: [main, master]
    paths:
      - "src/**"
      - "schema.sql"
      - "wrangler.toml"
  workflow_dispatch:
    inputs:
      deploy_action:
        description: "éƒ¨ç½²åŠ¨ä½œï¼šupdateï¼ˆå¸¸è§„æ›´æ–°ï¼‰/ initï¼ˆé¦–æ¬¡éƒ¨ç½²ï¼Œåˆ›å»º D1 + å»ºè¡¨ + éƒ¨ç½²ï¼‰"
        required: false
        default: "update"
        type: choice
        options:
          - update
          - init
      apply_schema:
        description: "æ‰§è¡Œå»ºè¡¨ SQLï¼štrue / false / autoï¼ˆauto ä»…åœ¨ schema.sql å˜æ›´æ—¶æ‰§è¡Œï¼‰"
        required: false
        default: "auto"
        type: choice
        options:
          - auto
          - "true"
          - "false"
  repository_dispatch:
    types: [deploy-mailone]

env:
  WORKER_NAME: mailone
  D1_DATABASE_NAME: mailone

jobs:
  check-config:
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}
      deploy_action: ${{ steps.plan.outputs.deploy_action }}
      should_apply_schema: ${{ steps.plan.outputs.should_apply_schema }}
      src_changed: ${{ steps.changes.outputs.src_changed }}
      schema_changed: ${{ steps.changes.outputs.schema_changed }}
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” æ£€æŸ¥éƒ¨ç½²å¼€å…³
        id: check
        run: |
          # æ‰‹åŠ¨è§¦å‘å’Œå¤–éƒ¨è°ƒç”¨å§‹ç»ˆå…è®¸éƒ¨ç½²
          if [[ "${{ github.event_name }}" != "push" ]]; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "âœ… é push è§¦å‘ï¼Œå…è®¸éƒ¨ç½²"
            exit 0
          fi

          ENABLED="${{ vars.AUTO_DEPLOY }}"
          [ -z "$ENABLED" ] && ENABLED="true"

          if [ "$ENABLED" = "true" ]; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "âœ… è‡ªåŠ¨éƒ¨ç½²å·²å¼€å¯"
          else
            echo "should_deploy=false" >> $GITHUB_OUTPUT
            echo "â¸ï¸ è‡ªåŠ¨éƒ¨ç½²å·²å…³é—­ï¼ˆè®¾ç½® AUTO_DEPLOY=true ä»¥å¯ç”¨ï¼‰"
          fi

      - name: ğŸ” æ£€æµ‹å˜æ›´èŒƒå›´
        id: changes
        run: |
          echo "src_changed=false" >> $GITHUB_OUTPUT
          echo "schema_changed=false" >> $GITHUB_OUTPUT

          if [[ "${{ github.event_name }}" != "push" ]]; then
            # é push è§¦å‘ï¼Œè§†ä¸ºå…¨é‡å˜æ›´
            echo "src_changed=true" >> $GITHUB_OUTPUT
            echo "schema_changed=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          before="${{ github.event.before }}"
          if [[ -z "$before" || "$before" == "0000000000000000000000000000000000000000" ]]; then
            echo "src_changed=true" >> $GITHUB_OUTPUT
            echo "schema_changed=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          if ! git cat-file -e "${before}^{commit}" 2>/dev/null; then
            echo "âš ï¸ before æäº¤ä¸å¯è¾¾ï¼Œè§†ä¸ºå…¨é‡å˜æ›´"
            echo "src_changed=true" >> $GITHUB_OUTPUT
            echo "schema_changed=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          CHANGED=$(git diff --name-only "$before" "${{ github.sha }}")

          if echo "$CHANGED" | grep -qE "^(src/|wrangler\.toml)"; then
            echo "src_changed=true" >> $GITHUB_OUTPUT
          fi
          if echo "$CHANGED" | grep -q "^schema.sql"; then
            echo "schema_changed=true" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ§­ ç”Ÿæˆéƒ¨ç½²è®¡åˆ’
        id: plan
        run: |
          deploy_action="${{ github.event.inputs.deploy_action }}"
          apply_schema="${{ github.event.inputs.apply_schema }}"

          # repository_dispatch æ”¯æŒ payload ä¼ å‚
          if [[ "${{ github.event_name }}" == "repository_dispatch" ]]; then
            [ -n "${{ github.event.client_payload.deploy_action }}" ] && deploy_action="${{ github.event.client_payload.deploy_action }}"
            [ -n "${{ github.event.client_payload.apply_schema }}" ] && apply_schema="${{ github.event.client_payload.apply_schema }}"
          fi

          [ -z "$deploy_action" ] && deploy_action="update"
          [ -z "$apply_schema" ] && apply_schema="auto"

          # init æ¨¡å¼å¼ºåˆ¶å»ºè¡¨
          if [[ "$deploy_action" == "init" ]]; then
            apply_schema="true"
          fi

          should_apply_schema="false"
          if [[ "$apply_schema" == "true" ]]; then
            should_apply_schema="true"
          elif [[ "$apply_schema" == "auto" && "${{ steps.changes.outputs.schema_changed }}" == "true" ]]; then
            should_apply_schema="true"
          fi

          echo "deploy_action=$deploy_action" >> $GITHUB_OUTPUT
          echo "should_apply_schema=$should_apply_schema" >> $GITHUB_OUTPUT

          echo "ğŸ“‹ éƒ¨ç½²è®¡åˆ’ï¼š"
          echo "  åŠ¨ä½œ: $deploy_action"
          echo "  å»ºè¡¨: $should_apply_schema"
          echo "  æºç å˜æ›´: ${{ steps.changes.outputs.src_changed }}"
          echo "  Schemaå˜æ›´: ${{ steps.changes.outputs.schema_changed }}"

  deploy:
    needs: check-config
    if: needs.check-config.outputs.should_deploy == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“¦ å®‰è£… Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: ğŸ“¦ å®‰è£… wrangler
        run: npm install -g wrangler

      - name: ğŸ”‡ å…³é—­ wrangler é¥æµ‹
        run: wrangler telemetry disable

      - name: ğŸ” æ£€æŸ¥ D1 æ•°æ®åº“
        id: check-db
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "æ£€æŸ¥ D1 æ•°æ®åº“æ˜¯å¦å­˜åœ¨..."
          DATABASE_LIST=$(wrangler d1 list --json 2>/dev/null || echo "[]")
          EXISTING_DB=$(echo "$DATABASE_LIST" | jq -r '.[] | select(.name=="${{ env.D1_DATABASE_NAME }}") | .uuid')

          if [ -n "$EXISTING_DB" ]; then
            echo "db_exists=true" >> $GITHUB_OUTPUT
            echo "database_id=$EXISTING_DB" >> $GITHUB_OUTPUT
            echo "âœ… æ‰¾åˆ°ç°æœ‰ D1 æ•°æ®åº“: $EXISTING_DB"
          else
            echo "db_exists=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ D1 æ•°æ®åº“ä¸å­˜åœ¨"
          fi

      - name: ğŸ†• åˆ›å»º D1 æ•°æ®åº“ï¼ˆé¦–æ¬¡éƒ¨ç½²ï¼‰
        id: create-db
        if: steps.check-db.outputs.db_exists != 'true' && needs.check-config.outputs.deploy_action == 'init'
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "åˆ›å»º D1 æ•°æ®åº“..."
          CREATE_OUTPUT=$(wrangler d1 create ${{ env.D1_DATABASE_NAME }} 2>&1)
          echo "$CREATE_OUTPUT"

          DATABASE_ID=$(echo "$CREATE_OUTPUT" | grep -oP '([0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12})')

          if [ -z "$DATABASE_ID" ]; then
            echo "âŒ æ— æ³•åˆ›å»º D1 æ•°æ®åº“"
            exit 1
          fi

          echo "database_id=$DATABASE_ID" >> $GITHUB_OUTPUT
          echo "âœ… D1 æ•°æ®åº“å·²åˆ›å»º: $DATABASE_ID"

      - name: âŒ æ•°æ®åº“ä¸å­˜åœ¨ä¸”é init æ¨¡å¼
        if: steps.check-db.outputs.db_exists != 'true' && needs.check-config.outputs.deploy_action != 'init'
        run: |
          echo "âŒ D1 æ•°æ®åº“ä¸å­˜åœ¨ï¼Œè¯·ä½¿ç”¨ init æ¨¡å¼é¦–æ¬¡éƒ¨ç½²"
          echo "   åœ¨ Actions é¡µé¢æ‰‹åŠ¨è§¦å‘ï¼Œé€‰æ‹© deploy_action = init"
          exit 1

      - name: ğŸ“ å†™å…¥ database_id åˆ° wrangler.toml
        run: |
          # ä¼˜å…ˆç”¨å·²æœ‰çš„ï¼Œå…¶æ¬¡ç”¨æ–°å»ºçš„
          DB_ID="${{ steps.check-db.outputs.database_id }}"
          [ -z "$DB_ID" ] && DB_ID="${{ steps.create-db.outputs.database_id }}"

          if [ -z "$DB_ID" ]; then
            echo "âŒ æ— æ³•è·å– database_id"
            exit 1
          fi

          sed -i "s/YOUR_D1_DATABASE_ID/$DB_ID/g" wrangler.toml
          sed -i -E "s/(database_id = \")([^\"]+)(\")/\1$DB_ID\3/" wrangler.toml
          echo "âœ… wrangler.toml å·²æ›´æ–° database_id = $DB_ID"
          cat wrangler.toml

      - name: ğŸ—ƒï¸ æ‰§è¡Œå»ºè¡¨ SQL
        if: needs.check-config.outputs.should_apply_schema == 'true'
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "æ‰§è¡Œ schema.sql..."
          wrangler d1 execute ${{ env.D1_DATABASE_NAME }} --remote --file=./schema.sql
          echo "âœ… å»ºè¡¨å®Œæˆ"

      - name: ğŸš€ éƒ¨ç½² Worker
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "éƒ¨ç½² Worker..."
          wrangler deploy
          echo "âœ… Worker éƒ¨ç½²æˆåŠŸ"

      - name: ğŸ“Š éƒ¨ç½²ç»“æœ
        if: always()
        run: |
          echo "===================================================="
          if [ "${{ job.status }}" == "success" ]; then
            echo "ğŸ‰ MailOne éƒ¨ç½²æˆåŠŸï¼"
            echo "===================================================="
            echo ""
            echo "ğŸ“® API åœ°å€: https://${{ env.WORKER_NAME }}.<your-subdomain>.workers.dev"
            echo "ğŸ“§ æ”¶ä»¶åŸŸå: éœ€åœ¨ Cloudflare Email Routing ä¸­é…ç½® Catch-all"
            echo ""
            echo "ä½¿ç”¨ç¤ºä¾‹:"
            echo "  curl \"https://${{ env.WORKER_NAME }}.<your-subdomain>.workers.dev/?to=test@your-domain.com\""
            echo ""
            if [[ "${{ needs.check-config.outputs.deploy_action }}" == "init" ]]; then
              echo "âš ï¸  é¦–æ¬¡éƒ¨ç½²åç»­æ­¥éª¤ï¼š"
              echo "  1. Cloudflare Dashboard â†’ åŸŸå â†’ Email â†’ Email Routing"
              echo "  2. å¼€å¯ Email Routing"
              echo "  3. Catch-all â†’ è·¯ç”±åˆ° Worker 'mailone'"
            fi
          else
            echo "âŒ MailOne éƒ¨ç½²å¤±è´¥ï¼è¯·æ£€æŸ¥æ—¥å¿—"
          fi
          echo "===================================================="
